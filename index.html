<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é€šç”¨æ‹ç…§è¨ˆæ•¸å·¥å…·</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
body {
  margin: 0;
  padding: 16px;
  background: #020617;
  color: #e5e7eb;
  font-family: system-ui, sans-serif;
  text-align: center;
}

h2 { margin-bottom: 12px; }

button {
  padding: 12px 18px;
  margin: 6px;
  font-size: 16px;
  font-weight: bold;
  border-radius: 12px;
  border: none;
}

.gallery { background:#38bdf8; }
.camera  { background:#facc15; }
.count   { background:#22c55e; }
.adjust  { background:#334155; color:#fff; font-size:22px; width:56px; }

canvas {
  max-width: 100%;
  margin-top: 14px;
  border-radius: 14px;
  background:#000;
}

#result { margin-top: 10px; font-size:18px; }
#manual { margin-top: 10px; display:none; }
</style>
</head>

<body>

<h2>ğŸ“¸ é€šç”¨æ‹ç…§è¨ˆæ•¸</h2>

<div>
  <button class="gallery" id="btnGallery">ğŸ–¼ ç›¸ç°¿</button>
  <button class="camera" id="btnCamera">ğŸ“¸ ç›¸æ©Ÿ</button>
</div>

<div>
  <button class="count" id="countBtn" disabled>â–¶ é–‹å§‹è¨ˆæ•¸</button>
</div>

<div id="result">â³ è¼‰å…¥ AI æ¨¡å‹ä¸­â€¦</div>

<div id="manual">
  <button class="adjust" id="minusBtn">â–</button>
  <span id="manualCount" style="font-size:20px;margin:0 14px;">0</span>
  <button class="adjust" id="plusBtn">â•</button>
</div>

<canvas id="canvas"></canvas>

<input type="file" accept="image/*" hidden id="fileInput">
<input type="file" accept="image/*" capture="environment" hidden id="cameraInput">

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const result = document.getElementById("result");
const manualDiv = document.getElementById("manual");
const manualCountText = document.getElementById("manualCount");

let img = new Image();
let model;
let detections = [];

/* åˆå§‹åŒ– */
async function init() {
  await tf.ready();
  await tf.setBackend("webgl");
  model = await cocoSsd.load();
  result.textContent = "âœ… æ¨¡å‹å°±ç·’ï¼Œè«‹é¸æ“‡ç…§ç‰‡";
  countBtn.disabled = false;
}
window.onload = init;

/* è¼‰å…¥åœ–ç‰‡ */
function loadImage(file) {
  const reader = new FileReader();
  reader.onload = () => {
    img.onload = () => {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img,0,0);
      detections = [];
      manualDiv.style.display = "none";
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
}

btnGallery.onclick = ()=>fileInput.click();
btnCamera.onclick = ()=>cameraInput.click();
fileInput.onchange = e => loadImage(e.target.files[0]);
cameraInput.onchange = e => loadImage(e.target.files[0]);

/* é–‹å§‹è¨ˆæ•¸ï¼ˆä¸çœ‹ classï¼‰ */
countBtn.onclick = async () => {
  ctx.drawImage(img,0,0);

  const preds = await model.detect(img);

  // â­ æ ¸å¿ƒï¼šåªç”¨ã€Œå¤§å°ã€åˆ¤æ–·æ˜¯ä¸æ˜¯ä¸€å€‹æ±è¥¿
  detections = preds.filter(p => {
    const [, , w, h] = p.bbox;
    return w > 40 && h > 40;   // â† é€šç”¨é–€æª»ï¼Œå¯ä¾æƒ…å¢ƒèª¿æ•´
  });

  redraw();
  manualDiv.style.display = "block";
};

/* é‡ç¹ª */
function redraw() {
  ctx.drawImage(img,0,0);

  detections.forEach((p,i)=>{
    const [x,y,w,h] = p.bbox;

    ctx.strokeStyle="#22c55e";
    ctx.lineWidth=3;
    ctx.strokeRect(x,y,w,h);

    ctx.fillStyle="#22c55e";
    ctx.font="bold 26px sans-serif";
    ctx.fillText(i+1, x+6, y+28);
  });

  result.textContent = `ğŸ”¢ ç›®å‰æ•¸é‡ï¼š${detections.length}`;
  manualCountText.textContent = detections.length;
}

/* é»æ“Šåˆªé™¤ç‰©ä»¶ */
canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left) * canvas.width / rect.width;
  const y = (e.clientY - rect.top) * canvas.height / rect.height;

  detections = detections.filter(p=>{
    const [bx,by,bw,bh] = p.bbox;
    return !(x>bx && x<bx+bw && y>by && y<by+bh);
  });

  redraw();
});

/* æ‰‹å‹•ä¿®æ­£ */
plusBtn.onclick = ()=>{
  manualCountText.textContent = Number(manualCountText.textContent) + 1;
};
minusBtn.onclick = ()=>{
  let v = Number(manualCountText.textContent);
  if(v>0) manualCountText.textContent = v - 1;
};
</script>

</body>
</html>
