<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ‰‹æ©Ÿæ‹ç…§è¨ˆæ•¸ Web App</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
      background: #0f172a;
      color: #e5e7eb;
    }
    h1 { font-size: 1.25rem; margin-bottom: 8px; }
    p { color: #cbd5f5; }
    .card {
      background: #020617;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      margin-bottom: 16px;
    }
    input[type=file] {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px dashed #334155;
      background: #020617;
      color: #e5e7eb;
    }
    button {
      margin-top: 12px;
      width: 100%;
      padding: 12px 16px;
      border-radius: 14px;
      border: none;
      background: #22c55e;
      color: #052e16;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
    }
    button:disabled { opacity: .5; cursor: not-allowed; }
    canvas { width: 100%; border-radius: 12px; margin-top: 12px; }
    .result { font-size: 1.1rem; margin-top: 8px; }
    .hint { font-size: .9rem; color: #94a3b8; }
  </style>
</head>
<body>
  <h1>ğŸ“¸ æ‰‹æ©Ÿæ‹ç…§è¨ˆæ•¸ï¼ˆWeb ç‰ˆï¼‰</h1>
  <p>ä¸ç”¨å®‰è£ Appï¼Œç›´æ¥ç”¨ç€è¦½å™¨æ‹ç…§æ•¸æ•¸é‡ã€‚</p>

  <div class="card">
    <!-- ç›¸ç°¿é¸æ“‡ -->
    <label style="display:block;margin-bottom:8px;">ğŸ“ å¾æ‰‹æ©Ÿé¸æ“‡ç…§ç‰‡</label>
    <input id="filePicker" type="file" accept="image/*" />

    <!-- ç›¸æ©Ÿæ‹ç…§ï¼ˆç¨ç«‹ inputï¼ŒAndroid æœ€ç©©å®šï¼‰ -->
    <label style="display:block;margin:12px 0 8px;">ğŸ“¸ ä½¿ç”¨ç›¸æ©Ÿæ‹ç…§</label>
    <input id="cameraPicker" type="file" accept="image/*" capture="environment" />

    <button id="countBtn" type="button">é–‹å§‹è¨ˆæ•¸</button>
    <div class="result" id="result">å°šæœªè¨ˆæ•¸</div>
    <div class="hint">è‹¥ç„¡åæ‡‰ï¼Œè«‹ç¢ºèªç€è¦½å™¨å…è¨±ç›¸æ©Ÿèˆ‡ç¶²è·¯</div>
    <canvas id="canvas"></canvas>
  </div>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

  <script>
    const filePicker = document.getElementById('filePicker');
    const cameraPicker = document.getElementById('cameraPicker');
    btn.disabled = false; // æ‰‹æ©Ÿç€è¦½å™¨ä¸é–æŒ‰éˆ•ï¼Œé¿å…èª¤åˆ¤
    const btn = document.getElementById('countBtn');
    const result = document.getElementById('result');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let img = new Image();
    let model = null;
    let imageReady = false;

    async function loadModel() {
      try {
        result.textContent = 'æ¨¡å‹è¼‰å…¥ä¸­â€¦ï¼ˆç¬¬ä¸€æ¬¡ç´„ 5â€“10 ç§’ï¼‰';
        model = await cocoSsd.load();
        result.textContent = 'æ¨¡å‹å·²å°±ç·’ï¼Œè«‹æ‹ç…§';
        toggleButton();
      } catch (e) {
        console.error(e);
        result.textContent = 'æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·š';
      }
    }

    // è¼‰å…¥ AI æ¨¡å‹ï¼ˆä¸€å®šè¦æˆåŠŸæ‰æœƒæœ‰åæ‡‰ï¼‰
    async function loadModel() {
      result.textContent = 'AI æ¨¡å‹è¼‰å…¥ä¸­â€¦';
      try {
        model = await cocoSsd.load();
        console.log('âœ… model loaded', model);
        result.textContent = 'æ¨¡å‹å·²å°±ç·’ï¼Œè«‹é–‹å§‹è¨ˆæ•¸';
      } catch (err) {
        console.error('âŒ model load failed', err);
        alert('AI æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–æ”¹ç”¨ Chrome');
      }
    }
    loadModel();

    
      input.setAttribute('accept', 'image/*');
      input.setAttribute('capture', 'environment');
      input.click();
    });
      input.click();
    });

    function handleFile(file) {
      if (!file) return;
      img = new Image();
      img.onload = () => {
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        ctx.drawImage(img, 0, 0);
        result.textContent = 'ç…§ç‰‡å·²è¼‰å…¥ï¼Œå¯é–‹å§‹è¨ˆæ•¸';
      };
      img.onerror = () => {
        result.textContent = 'åœ–ç‰‡è¼‰å…¥å¤±æ•—';
      };
      img.src = URL.createObjectURL(file);
    }

    filePicker.addEventListener('change', () => handleFile(filePicker.files[0]));
    cameraPicker.addEventListener('change', () => handleFile(cameraPicker.files[0]));
      img.onload = async () => {
        await img.decode?.();
        canvas.width = img.naturalWidth || img.width;
        canvas.height = img.naturalHeight || img.height;
        ctx.drawImage(img, 0, 0);
        imageReady = true;
        toggleButton();
        result.textContent = 'ç…§ç‰‡å·²è¼‰å…¥ï¼Œæº–å‚™è¨ˆæ•¸';
      };
    });

    function toggleButton() {
      // å·²æ£„ç”¨ï¼šæ‰‹æ©Ÿç€è¦½å™¨ç‹€æ…‹ä¸å¯é 
    }

    btn.addEventListener('click', async () => {
      console.log('â–¶ count clicked');

      if (!img || !img.complete) {
        alert('å°šæœªè¼‰å…¥ç…§ç‰‡');
        return;
      }
      if (!model) {
        alert('AI æ¨¡å‹å°šæœªè¼‰å…¥å®Œæˆ');
        return;
      }

      result.textContent = 'åˆ†æä¸­â€¦';
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);

      try {
        const predictions = await model.detect(canvas);
        console.log('predictions', predictions);

        predictions.forEach(p => {
          const [x, y, w, h] = p.bbox;
          ctx.strokeStyle = '#22c55e';
          ctx.lineWidth = 3;
          ctx.strokeRect(x, y, w, h);
        });

        result.textContent = `åµæ¸¬åˆ° ${predictions.length} å€‹ç‰©ä»¶`;
      } catch (err) {
        console.error('âŒ detect failed', err);
        alert('è¾¨è­˜å¤±æ•—ï¼Œè«‹é–‹ console æŸ¥çœ‹éŒ¯èª¤');
      }
    });
        result.textContent = `åµæ¸¬åˆ° ${predictions.length} å€‹ç‰©ä»¶`;
      } catch (e) {
        console.error(e);
        alert('åˆ†æå¤±æ•—ï¼Œè«‹é–‹å•Ÿç€è¦½å™¨ console æŸ¥çœ‹éŒ¯èª¤');
      }
    });

        result.textContent = `åµæ¸¬åˆ° ${predictions.length} å€‹ç‰©ä»¶`;
      } catch (e) {
        console.error(e);
        result.textContent = 'åˆ†æå¤±æ•—ï¼Œè«‹æ›ä¸€å¼µç…§ç‰‡å†è©¦';
      }
    });

        result.textContent = `åµæ¸¬åˆ° ${predictions.length} å€‹ç‰©ä»¶`;
      } catch (e) {
        console.error(e);
        result.textContent = 'åˆ†æå¤±æ•—ï¼Œè«‹æ›ä¸€å¼µç…§ç‰‡å†è©¦';
      }
    });

      result.textContent = `åµæ¸¬åˆ° ${predictions.length} å€‹ç‰©ä»¶`;
    });
  </script>
</body>
</html>
