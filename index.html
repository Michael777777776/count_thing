<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI + æ‰‹å‹•è£œæ¡†è¨ˆæ•¸</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
body{
  margin:0;
  padding:16px;
  background:#020617;
  color:#e5e7eb;
  font-family:system-ui,sans-serif;
  text-align:center;
}
button{
  padding:12px 16px;
  margin:6px;
  font-size:16px;
  font-weight:bold;
  border-radius:12px;
  border:none;
}
.gallery{background:#38bdf8;}
.camera{background:#facc15;}
.ai{background:#22c55e;}
.clear{background:#ef4444;}

canvas{
  max-width:100%;
  margin-top:14px;
  border-radius:14px;
  background:#000;
  touch-action:none;
}
#result{margin-top:10px;font-size:18px;}
</style>
</head>

<body>

<h2>ğŸ“¦ AI åµæ¸¬ + æ‰‹å‹•è£œæ¡†</h2>

<div>
  <button class="gallery" id="btnGallery">ğŸ–¼ ç›¸ç°¿</button>
  <button class="camera" id="btnCamera">ğŸ“¸ ç›¸æ©Ÿ</button>
</div>

<div>
  <button class="ai" id="aiBtn" disabled>ğŸ¤– AI åµæ¸¬</button>
  <button class="clear" id="clearBtn">ğŸ§¹ æ¸…é™¤æ¡†</button>
</div>

<div id="result">â³ è¼‰å…¥æ¨¡å‹ä¸­â€¦</div>

<canvas id="canvas"></canvas>

<input type="file" accept="image/*" hidden id="fileInput">
<input type="file" accept="image/*" capture="environment" hidden id="cameraInput">

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const result = document.getElementById("result");

let img = new Image();
let model;
let boxes = []; // æ‰€æœ‰æ¡†
let drawing = false;
let startX, startY;

/* åˆå§‹åŒ– */
async function init(){
  await tf.ready();
  await tf.setBackend("webgl");
  model = await cocoSsd.load();
  result.textContent = "âœ… æ¨¡å‹å°±ç·’ï¼Œè«‹è¼‰å…¥ç…§ç‰‡";
  aiBtn.disabled = false;
}
window.onload = init;

/* è¼‰å…¥åœ–ç‰‡ */
function loadImage(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    img.onload = ()=>{
      canvas.width = img.width;
      canvas.height = img.height;
      boxes = [];
      redraw();
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
}

btnGallery.onclick = ()=>fileInput.click();
btnCamera.onclick = ()=>cameraInput.click();
fileInput.onchange = e=>loadImage(e.target.files[0]);
cameraInput.onchange = e=>loadImage(e.target.files[0]);

/* AI åµæ¸¬ï¼ˆç”¢ç”Ÿåˆå§‹æ¡†ï¼‰ */
aiBtn.onclick = async ()=>{
  const preds = await model.detect(img);

  preds.forEach(p=>{
    const [x,y,w,h] = p.bbox;
    if(w>60 && h>60){
      boxes.push({x,y,w,h});
    }
  });
  redraw();
};

/* æ‰‹å‹•ç•«æ¡†ï¼ˆè£œç®±å­ï¼‰ */
canvas.addEventListener("pointerdown",e=>{
  const r=canvas.getBoundingClientRect();
  startX=(e.clientX-r.left)*canvas.width/r.width;
  startY=(e.clientY-r.top)*canvas.height/r.height;
  drawing=true;
});

canvas.addEventListener("pointerup",e=>{
  if(!drawing) return;
  const r=canvas.getBoundingClientRect();
  const endX=(e.clientX-r.left)*canvas.width/r.width;
  const endY=(e.clientY-r.top)*canvas.height/r.height;
  const w=Math.abs(endX-startX);
  const h=Math.abs(endY-startY);

  if(w>30 && h>30){
    boxes.push({
      x:Math.min(startX,endX),
      y:Math.min(startY,endY),
      w,h
    });
  }
  drawing=false;
  redraw();
});

/* é»æ“Šåˆªé™¤æ¡† */
canvas.addEventListener("click",e=>{
  const r=canvas.getBoundingClientRect();
  const x=(e.clientX-r.left)*canvas.width/r.width;
  const y=(e.clientY-r.top)*canvas.height/r.height;

  boxes = boxes.filter(b =>
    !(x>b.x && x<b.x+b.w && y>b.y && y<b.y+b.h)
  );
  redraw();
});

/* æ¸…é™¤ */
clearBtn.onclick=()=>{
  boxes=[];
  redraw();
};

/* é‡ç¹ª */
function redraw(){
  ctx.drawImage(img,0,0);
  boxes.forEach((b,i)=>{
    ctx.strokeStyle="#22c55e";
    ctx.lineWidth=3;
    ctx.strokeRect(b.x,b.y,b.w,b.h);

    ctx.fillStyle="#22c55e";
    ctx.font="bold 22px sans-serif";
    ctx.fillText(i+1,b.x+6,b.y+24);
  });
  result.textContent=`ğŸ”¢ ç›®å‰ç®±å­æ•¸é‡ï¼š${boxes.length}`;
}
</script>

</body>
</html>
