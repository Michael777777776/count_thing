<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ğŸ“¸ æ‹ç…§è¨ˆæ•¸å·¥å…·</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
body{
  font-family: system-ui, -apple-system;
  background:#0f172a;
  color:#fff;
  text-align:center;
  margin:0;
  padding:16px;
}
button{
  padding:12px 18px;
  font-size:16px;
  border:none;
  border-radius:10px;
  cursor:pointer;
}
#aiBtn{ background:#22c55e; color:#000; }
#fileInput{ display:none; }
label{
  background:#334155;
  padding:10px 16px;
  border-radius:10px;
  cursor:pointer;
  display:inline-block;
  margin-bottom:10px;
}
#count{
  margin:12px 0;
  font-size:20px;
}
#wrap{
  position:relative;
  display:inline-block;
  margin-top:10px;
}
canvas{
  max-width:100%;
  border-radius:12px;
  background:#000;
}
</style>
</head>

<body>

<h2>ğŸ“¸ æ‹ç…§è¨ˆæ•¸å·¥å…·</h2>

<label>
  é¸æ“‡ç…§ç‰‡
  <input id="fileInput" type="file" accept="image/*" />
</label>

<br/>
<button id="aiBtn">â–¶ AI åµæ¸¬</button>

<div id="count">åµæ¸¬åˆ° 0 å€‹ç‰©ä»¶</div>

<div id="wrap">
  <canvas id="canvas"></canvas>
</div>

<script>
let model;
let boxes = [];
let img = new Image();

const fileInput = document.getElementById("fileInput");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const countDiv = document.getElementById("count");
const aiBtn = document.getElementById("aiBtn");

let startX, startY, drawing = false;

// è¼‰å…¥æ¨¡å‹
(async ()=>{
  model = await cocoSsd.load();
  console.log("æ¨¡å‹å·²è¼‰å…¥");
})();

// è¼‰å…¥åœ–ç‰‡
fileInput.onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  img.onload = ()=>{
    canvas.width = img.width;
    canvas.height = img.height;
    boxes = [];
    redraw();
  };
  img.src = url;
};

// AI åµæ¸¬ï¼ˆé‡é»ï¼šå…ˆæ¸…ç©ºï¼‰
aiBtn.onclick = async ()=>{
  if(!model || !img.src) return;

  boxes = []; // â­ é˜²æ­¢æ•¸é‡ä¸€ç›´å¢åŠ 

  const preds = await model.detect(img);

  preds.forEach(p=>{
    const [x,y,w,h] = p.bbox;
    if(w>40 && h>40){
      boxes.push({x,y,w,h});
    }
  });

  redraw();
};

// ç•«é¢é‡ç¹ª
function redraw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0);

  ctx.font = "20px sans-serif";
  ctx.lineWidth = 3;

  boxes.forEach((b,i)=>{
    ctx.strokeStyle="#22c55e";
    ctx.strokeRect(b.x,b.y,b.w,b.h);

    ctx.fillStyle="#22c55e";
    ctx.fillText(i+1, b.x+6, b.y+22);
  });

  countDiv.textContent = `åµæ¸¬åˆ° ${boxes.length} å€‹ç‰©ä»¶`;
}

// é»æ“Šæ¡†æ¡†åˆªé™¤
canvas.onclick = e=>{
  const r = canvas.getBoundingClientRect();
  const x = (e.clientX-r.left) * canvas.width/r.width;
  const y = (e.clientY-r.top) * canvas.height/r.height;

  boxes = boxes.filter(b =>
    !(x>b.x && x<b.x+b.w && y>b.y && y<b.y+b.h)
  );
  redraw();
};

// æ‰‹å‹•ç•«æ¡†ï¼ˆæ»‘é¼  / è§¸æ§ï¼‰
canvas.onmousedown = e=>{
  drawing = true;
  const r = canvas.getBoundingClientRect();
  startX = (e.clientX-r.left) * canvas.width/r.width;
  startY = (e.clientY-r.top) * canvas.height/r.height;
};

canvas.onmouseup = e=>{
  if(!drawing) return;
  drawing = false;

  const r = canvas.getBoundingClientRect();
  const endX = (e.clientX-r.left) * canvas.width/r.width;
  const endY = (e.clientY-r.top) * canvas.height/r.height;

  const x = Math.min(startX,endX);
  const y = Math.min(startY,endY);
  const w = Math.abs(endX-startX);
  const h = Math.abs(endY-startY);

  if(w>20 && h>20){
    boxes.push({x,y,w,h});
    redraw();
  }
};
</script>

</body>
</html>
