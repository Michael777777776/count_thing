<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ‹ç…§è¨ˆæ•¸å·¥å…·</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
body {
  margin: 0;
  padding: 16px;
  background: #0f172a;
  color: #e5e7eb;
  font-family: system-ui, sans-serif;
  text-align: center;
}

h2 { margin-bottom: 10px; }

button, select {
  padding: 12px 16px;
  margin: 6px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
  font-weight: bold;
}

.gallery { background:#38bdf8; }
.camera  { background:#facc15; }
.count   { background:#22c55e; }
.adjust  { background:#334155; color:#fff; font-size:22px; width:56px; }

canvas {
  max-width: 100%;
  margin-top: 14px;
  border-radius: 12px;
  background:#020617;
}

#manual { margin-top: 10px; display:none; }
#result { margin-top: 10px; }

</style>
</head>

<body>

<h2>ğŸ“¸ æ‹ç…§è¨ˆæ•¸å·¥å…·</h2>

<div>
  <button class="gallery" id="btnGallery">ğŸ–¼ ç›¸ç°¿</button>
  <button class="camera" id="btnCamera">ğŸ“¸ ç›¸æ©Ÿ</button>
</div>

<div>
  <select id="classFilter">
    <option value="all">ğŸ” æ‰€æœ‰ç‰©ä»¶</option>
    <option value="person">ğŸ‘¤ äºº</option>
    <option value="chair">ğŸª‘ æ¤…å­</option>
    <option value="bottle">ğŸ§´ ç“¶å­</option>
  </select>
</div>

<div>
  <button class="count" id="countBtn" disabled>â–¶ é–‹å§‹è¨ˆæ•¸</button>
</div>

<div id="result">â³ åˆå§‹åŒ–ä¸­â€¦</div>

<div id="manual">
  <button class="adjust" id="minusBtn">â–</button>
  <span id="manualCount" style="font-size:18px;margin:0 10px;">0</span>
  <button class="adjust" id="plusBtn">â•</button>
</div>

<canvas id="canvas"></canvas>

<input type="file" accept="image/*" hidden id="fileInput">
<input type="file" accept="image/*" capture="environment" hidden id="cameraInput">

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const result = document.getElementById("result");
const manualDiv = document.getElementById("manual");
const manualCountText = document.getElementById("manualCount");

let img = new Image();
let model;
let detections = [];
let manualCount = 0;

/* åˆå§‹åŒ– AI */
async function init() {
  await tf.ready();
  await tf.setBackend("webgl");
  model = await cocoSsd.load();
  result.textContent = "âœ… æ¨¡å‹å°±ç·’ï¼Œè«‹é¸æ“‡ç…§ç‰‡";
  countBtn.disabled = false;
}
window.onload = init;

/* è¼‰å…¥åœ–ç‰‡ */
function loadImage(file) {
  const reader = new FileReader();
  reader.onload = () => {
    img.onload = () => {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img,0,0);
      detections = [];
      manualDiv.style.display = "none";
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
}

btnGallery.onclick = ()=>fileInput.click();
btnCamera.onclick = ()=>cameraInput.click();
fileInput.onchange = e => loadImage(e.target.files[0]);
cameraInput.onchange = e => loadImage(e.target.files[0]);

/* é–‹å§‹è¨ˆæ•¸ */
countBtn.onclick = async () => {
  ctx.drawImage(img,0,0);
  const selected = classFilter.value;

  const preds = await model.detect(img);
  detections = preds.filter(p =>
    selected === "all" || p.class === selected
  );

  manualCount = detections.length;
  manualCountText.textContent = manualCount;
  manualDiv.style.display = "block";
  redraw();
};

/* é‡ç¹ªç•«é¢ */
function redraw() {
  ctx.drawImage(img,0,0);

  detections.forEach((p,i)=>{
    const [x,y,w,h] = p.bbox;

    ctx.strokeStyle="#22c55e";
    ctx.lineWidth=3;
    ctx.strokeRect(x,y,w,h);

    ctx.fillStyle="#22c55e";
    ctx.font="bold 26px sans-serif";
    ctx.fillText(`#${i+1}`, x+4, y+26);
  });

  result.textContent = `ğŸ¤– åµæ¸¬ç‰©ä»¶ï¼š${detections.length}`;
  manualCountText.textContent = detections.length;
}

/* é»æ“Šåˆªé™¤æ¡†æ¡† */
canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left) * canvas.width / rect.width;
  const y = (e.clientY - rect.top) * canvas.height / rect.height;

  detections = detections.filter(p=>{
    const [bx,by,bw,bh] = p.bbox;
    return !(x>bx && x<bx+bw && y>by && y<by+bh);
  });

  redraw();
});

/* æ‰‹å‹•å¾®èª¿ */
plusBtn.onclick = ()=>{
  manualCount++;
  manualCountText.textContent = manualCount;
};

minusBtn.onclick = ()=>{
  if(manualCount>0) manualCount--;
  manualCountText.textContent = manualCount;
};
</script>

</body>
</html>
